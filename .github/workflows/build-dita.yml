name: build-dita

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install DITA-OT
        run: |
          curl -L -o dita-ot.zip https://github.com/dita-ot/dita-ot/releases/download/4.2.1/dita-ot-4.2.1.zip
          unzip dita-ot.zip
          echo "$GITHUB_WORKSPACE/dita-ot-4.2.1/bin" >> $GITHUB_PATH

      - name: Ensure customization folders exist
        run: |
          mkdir -p dita-ot-4.2.1/plugins/org.dita.base/customization/xsl/html5
          mkdir -p dita-ot-4.2.1/plugins/org.dita.html5/xsl/html5/template/head

      - name: Copy custom files into DITA-OT
        run: |
          cp customization/xsl/html5/custom.xsl dita-ot-4.2.1/plugins/org.dita.base/customization/xsl/html5/

      - name: üîß Build full map with navigation buttons
        run: |
          dita -i topics/course_map.ditamap -f html5 -o out \
            -Dargs.css=mytheme.css \
            -Dargs.cssroot=customization/css \
            -Dargs.copycss=yes \
            -Dargs.rellinks=next-prev \
            -Dargs.xhtml.classattr=yes \
            -Dnav-toc=full \
            -Dhtml5.xsl=customization/xsl/html5/custom.xsl

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Inject Hypothes.is into HTML pages
        run: |
          node .github/scripts/inject-hypothesis.js

      - name: Inject Prism.js into HTML pages
        run: |
          node .github/scripts/inject-head-snippets.js

      - name: ‚úÖ Copy quizzes and JS loader to output
        run: |
          mkdir -p out/customization/quizzes
          mkdir -p out/customization/js
          cp customization/quizzes/* out/customization/quizzes/
          cp customization/js/* out/customization/js/

      - name: üí° Inject next-lesson buttons
        run: |
          node .github/scripts/inject-next-lesson-footer.js

      - name: üì¶ Copy homepage to index.html
        run: |
          cp out/dita_structured_authoring.html out/index.html

      - name: üßê Inspect HTML output for next-lesson buttons
        run: |
          echo "üîç Checking output HTML files for injected next-lesson buttons:"
          grep -r 'class="next-lesson"' out/ || echo "‚ùå No next-lesson buttons found"

      - name: Overwrite default CSS (commonltr.css)
        run: |
          cp -f customization/css/mytheme.css out/commonltr.css

      - name: üì§ Copy quiz loader script to output
        run: |
          mkdir -p out/customization/js
          cp customization/js/quiz-loader.js out/customization/js/quiz-loader.js

      - name: üîç Debug output structure
        run: |
          echo "=== Output directory structure ==="
          find out -name "*.js" -o -name "*.html" | head -20
          echo ""
          echo "=== Quiz files ==="
          ls -la out/customization/quizzes/ || echo "Quizzes directory not found"
          echo ""
          echo "=== JS files ==="  
          ls -la out/customization/js/ || echo "JS directory not found"
          echo ""
          echo "=== Checking if quiz is referenced in HTML ==="
          grep -r "data-quiz" out/ || echo "No data-quiz found in HTML files"
          echo ""
          echo "=== Checking if quiz-loader is referenced in HTML ==="
          grep -r "quiz-loader.js" out/ || echo "No quiz-loader.js found in HTML files"

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
